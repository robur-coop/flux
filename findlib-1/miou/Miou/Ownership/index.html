<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Ownership (docs.findlib-1.miou.Miou.Ownership)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../../../../index.html">Index</a> &#x00BB; <a href="../../../../index.html">docs</a> &#x00BB; <a href="../../../index.html">findlib-1</a> &#x00BB; <a href="../../index.html">miou</a> &#x00BB; <a href="../index.html">Miou</a> &#x00BB; Ownership</nav><header class="odoc-preamble"><h1>Module <code><span>Miou.Ownership</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#ownership-of-resources.">Ownership of resources.</a></li></ul></nav></div><div class="odoc-content"><h3 id="ownership-of-resources."><a href="#ownership-of-resources." class="anchor"></a>Ownership of resources.</h3><pre>La propriété, c'est le vol!</pre><p>Beyond the capitalist idea (even if certain libertarians would qualify the notion of private property), it is often useful to associate resources with the execution of a task in order to free them as soon as the said task is completed (abnormally or not).</p><p>Miou offers such a mechanism where the user can associate a resource <code>'a</code> with a promise (with <a href="#val-own"><code>own</code></a>). When the task associated with this promise is terminated, Miou will check that all the resources have been released (using <a href="#val-disown"><code>disown</code></a>). If this is not the case, Miou will call the &quot;finaliser&quot; specified by the user and fail with an &quot;uncatchable&quot; exception: <code>Resource_leaked</code>.</p><p>Note that the user must release these resources <b>and</b> <a href="#val-disown"><code>disown</code></a>. In fact, <a href="#val-disown"><code>disown</code></a> does <b>not</b> call the finaliser (which is only executed in an abnormal situation: when the task has raised an exception, when the task has been cancelled or when a resource has not been released).</p><p>The aim of this module is to ensure that when a task is completed, all resources have been released.</p><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>The type of resources.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span><span class="label">finally</span>:<span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>create ~finally v</code> associates a value <code>v</code> and a <code>finaliser</code> to return a <i>resource</i>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-check"><a href="#val-check" class="anchor"></a><code><span><span class="keyword">val</span> check : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>check t</code> verifies that the given resource <code>t</code> is owned by the current task. If a task tries to use a resource that does not belong to it, <a href="#val-check"><code>check</code></a> will raise an <i>uncatchable</i> exception <code>Not_owner</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-own"><a href="#val-own" class="anchor"></a><code><span><span class="keyword">val</span> own : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>own t</code> associates the given resource <code>t</code> to the current task. This way, if the current task fails abnormally, the <code>finally</code> function will be called.</p><pre class="language-ocaml"><code>  # let show () = print_endline &quot;Resource released!&quot;
  # Miou.run @@ fun () -&gt;
    let p = Miou.async @@ fun () -&gt;
      let t = Miou.Ownership.create ~finally:show () in
      Miou.Ownership.own t;
      failwith &quot;p&quot; in
    await_exn p ;;
  Resource released!
  Exception: Failure &quot;p&quot;.</code></pre><p><b>NOTE</b>: Finaliser <b>can not</b> perform OCaml's effects. This is because it is not &quot;ordered&quot; like an usual task. Using Miou functions (such as <a href="../index.html#val-await"><code>await</code></a> or <a href="../index.html#val-cancel"><code>cancel</code></a>) in the finaliser will raise an exception: <a href="../../../../stdlib/Stdlib/Effect/index.html#exception-Unhandled"><code>Effect.Unhandled</code></a>.</p><p>It is also important to note that if a task finishes abnormally, as well as freeing up the resources of that task, the resources owned by the children will also be freed up (hence the uselessness of using await or cancel).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-disown"><a href="#val-disown" class="anchor"></a><code><span><span class="keyword">val</span> disown : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>disown t</code> informs Miou that you have properly released the resource. If the current task ends well and the user has not <code>disown</code> the resource, Miou raises the uncatchable exception: <code>Resource_leaked</code></p><pre class="language-ocaml"><code>  # let show () = print_endline &quot;Resource released!&quot; ;;
  # Miou.run @@ fun () -&gt;
    let p = Miou.async @@ fun () -&gt;
      let t = Miou.Ownership.create ~finally:show () in
      Miou.Ownership.own t in
    await_exn p ;;
  Resource released!
  Exception: Miou.Resource_leak.</code></pre><p>Note that even in this abnormal situation, Miou calls the finaliser.</p><p>However, <code>finally</code> <b>is not</b> called by <code>disown</code>. For example, if we had associated <code>Unix.close</code> as a <code>finally</code> with a file descriptor as a resource, <code>disown</code> <b>does not</b> close the file descriptor and it is up to the user to explicitly close the file descriptor.</p><p>If you want to <code>disown</code> AND call <code>finally</code>, you should use <a href="#val-release"><code>release</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-release"><a href="#val-release" class="anchor"></a><code><span><span class="keyword">val</span> release : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>release t</code> properly released the resource (and call <code>finally</code>) and informs Miou that the resource is properly released. If the current task fails (via cancellation or exception) after <code>release</code>, the resource finaliser will not be called.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-transfer"><a href="#val-transfer" class="anchor"></a><code><span><span class="keyword">val</span> transfer : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>transfer t</code> transfers the ownership of a resource to the parent task. It is useful when a sub-task operates to the resource owned by its parent and would like to retransfer it at the end:</p><pre class="language-ocaml"><code>  exception Timeout

  let with_timeout ~give sec fn =
    Miou.await_first
      [
        (Miou.async @@ fun () -&gt; Miou_unix.sleep sec; raise Timeout)
      ; Miou.async ~give fn
      ]

  let connect socket sockaddr =
    let t = Miou_unix.Ownership.resource socket in
    with_timeout ~give:[ t ] 1.0 @@ fun () -&gt;
    Miou_unix.Ownership.connect socket sockaddr;
    Miou.Ownership.transfer t</code></pre></div></div></div></body></html>
